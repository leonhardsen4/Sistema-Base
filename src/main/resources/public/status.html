<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status - Sistema</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/logo.png">
  <link rel="apple-touch-icon" href="/img/logo.png">
  <link rel="stylesheet" href="/css/style.css">
</head>
  <!-- Modal Novo/Editar -->
  <div id="modalStatus" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitulo">Novo Status</h3>
        <button class="modal-close" onclick="fecharModalStatus()">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="statusId" />
        <div class="form-group">
          <label for="statusNome">Nome *</label>
          <input type="text" id="statusNome" maxlength="100" required />
        </div>
        <div class="form-group">
          <label for="statusCor">Cor *</label>
          <input type="color" id="statusCor" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancelar" onclick="fecharModalStatus()">Cancelar</button>
        <button class="btn-salvar" onclick="salvarStatus()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    function getToken() { return localStorage.getItem('auth_token'); }

    // Toggle de tema
    function initThemeToggle() {
      const toggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('theme') || 'light';

      // Aplicar tema salvo
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeToggleUI(savedTheme);

      // Event listener para toggle
      toggle.querySelectorAll('.theme-toggle-option').forEach(option => {
        option.addEventListener('click', () => {
          const theme = option.dataset.theme;
          document.documentElement.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
          updateThemeToggleUI(theme);
        });
      });
    }

    function updateThemeToggleUI(theme) {
      document.querySelectorAll('.theme-toggle-option').forEach(option => {
        if (option.dataset.theme === theme) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    window.addEventListener('DOMContentLoaded', async () => {
      initThemeToggle();

      const token = getToken();
      if (!token) { window.location.href = '/login.html'; return; }
      // Prefetch usuário
      const uLocal = localStorage.getItem('usuario');
      if (uLocal) {
        try { const u = JSON.parse(uLocal); if (u && u.nome) { document.getElementById('userName').textContent = u.nome; document.getElementById('userEmail').textContent = u.email || ''; } } catch {}
      } else {
        try {
          const resp = await fetch('/api/auth/verificar', { headers: { 'Authorization': 'Bearer ' + token } });
          const json = await resp.json();
          if (json.sucesso) { document.getElementById('userName').textContent = json.usuario.nome; document.getElementById('userEmail').textContent = json.usuario.email; }
        } catch {}
      }
      carregarStatus();
    });

    async function carregarStatus() {
      const body = document.getElementById('statusBody');
      try {
        const resp = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + getToken() } });
        const json = await resp.json();
        const itens = json.dados || [];
        if (!itens.length) { body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">Nenhum status cadastrado</td></tr>'; return; }
        body.innerHTML = itens.map(s => {
          const cor = s.corHex || '#ccc';
          const txtColor = getCorTexto(cor);
          return `
            <tr data-id="${s.id}">
              <td><span class="badge"><span class="color-dot" style="background:${cor}"></span>${s.nome}</span></td>
              <td><span style="background:${cor};color:${txtColor};padding:6px 10px;border-radius:8px;border:1px solid #e5e7eb;">${cor}</span></td>
              <td>${s.dataCriacao || '-'}</td>
              <td class="actions">
                <button class="btn-table" onclick="editarStatus(${s.id}, '${escapeHtml(s.nome)}', '${cor}')" title="Editar">✎</button>
                <button class="btn-table" onclick="excluirStatus(${s.id})" title="Excluir">✕</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        console.error('Erro ao carregar status:', e);
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444;">Erro ao carregar status</td></tr>';
      }
    }

    function abrirModalNovo() {
      document.getElementById('statusId').value = '';
      document.getElementById('statusNome').value = '';
      document.getElementById('statusCor').value = '#667eea';
      document.getElementById('modalTitulo').textContent = 'Novo Status';
      document.getElementById('modalStatus').style.display = 'flex';
    }

    function editarStatus(id, nome, cor) {
      document.getElementById('statusId').value = id;
      document.getElementById('statusNome').value = unescapeHtml(nome);
      document.getElementById('statusCor').value = cor || '#667eea';
      document.getElementById('modalTitulo').textContent = 'Editar Status';
      document.getElementById('modalStatus').style.display = 'flex';
    }

    function fecharModalStatus() { document.getElementById('modalStatus').style.display = 'none'; }

    async function salvarStatus() {
      const id = document.getElementById('statusId').value;
      const nome = document.getElementById('statusNome').value.trim();
      const cor = document.getElementById('statusCor').value;
      if (!nome) { alert('Informe o nome do status'); return; }
      if (!/^#([A-Fa-f0-9]{6})$/.test(cor)) { alert('Selecione uma cor válida'); return; }
      const payload = { nome, corHex: cor };
      try {
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
          body: JSON.stringify(payload)
        };
        const url = id ? `/api/status/${id}` : '/api/status';
        const resp = await fetch(url, opts);
        const json = await resp.json();
        if (!resp.ok || !json.sucesso) throw new Error(json.mensagem || 'Falha ao salvar');
        fecharModalStatus();
        carregarStatus();
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirStatus(id) {
      const ok = confirm('Excluir este status?');
      if (!ok) return;
      try {
        const resp = await fetch(`/api/status/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getToken() } });
        const json = await resp.json();
        if (!resp.ok || !json.sucesso) throw new Error(json.mensagem || 'Falha ao excluir');
        carregarStatus();
      } catch (e) { alert('Erro ao excluir: ' + e.message); }
    }

    function getCorTexto(bg) {
      try {
        const hex = bg.replace('#','');
        const r = parseInt(hex.substr(0,2),16), g = parseInt(hex.substr(2,2),16), b = parseInt(hex.substr(4,2),16);
        const luminance = (0.299*r + 0.587*g + 0.114*b);
        return luminance > 186 ? '#111827' : '#ffffff';
      } catch(_) { return '#ffffff'; }
    }

    function escapeHtml(s) { return String(s).replace(/["&'<>]/g, (c) => ({'"':'&quot;','&':'&amp;','\'':'&#39;','<':'&lt;','>':'&gt;'}[c])); }
    function unescapeHtml(s) { const d = document.createElement('textarea'); d.innerHTML = s; return d.value; }

    async function logout() {
      try { const token = getToken(); await fetch('/api/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } }); } catch {}
      localStorage.removeItem('auth_token'); localStorage.removeItem('usuario'); window.location.href = '/login.html';
    }

    // Toggle da sidebar colapsável
    (function() {
      const layout = document.querySelector('.layout');
      const btn = document.getElementById('btnSidebarToggle');
      function applyState() {
        const collapsed = localStorage.getItem('sidebar_collapsed') === '1';
        if (collapsed) layout.classList.add('collapsed'); else layout.classList.remove('collapsed');
        if (btn) btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      }
      window.addEventListener('DOMContentLoaded', applyState);
      if (btn) {
        btn.addEventListener('click', () => {
          const collapsed = layout.classList.toggle('collapsed');
          localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0');
          btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        });
      }
    })();
  </script>
</body>
</html>