<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìã Notisblokk - Sistema</title>
  <link rel="stylesheet" href="/css/layout.css">
  <!-- Datepicker (Flatpickr) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }

    /* Layout principal - Single column */
    .notisblokk-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-header h3 {
      font-size: 16px;
      color: #1f2937;
      margin: 0;
    }

    /* Etiquetas - Se√ß√£o horizontal */
    .etiquetas-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .etiquetas-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .etiquetas-section-header h3 {
      margin: 0;
      font-size: 16px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .etiquetas-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .etiquetas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }

    .etiqueta-card {
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
      cursor: pointer;
    }

    .etiqueta-card:hover {
      border-color: #667eea;
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.15);
      transform: translateY(-1px);
    }

    .etiqueta-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      flex: 1;
      min-width: 0;
    }

    .etiqueta-info strong {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .etiqueta-contador {
      font-size: 11px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .etiqueta-acoes {
      display: flex;
      gap: 2px;
      flex-shrink: 0;
    }

    .btn-icone-small {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 2px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .btn-icone-small:hover {
      opacity: 1;
    }

    /* Alertas - Se√ß√£o colaps√°vel no topo */
    .alertas-section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .alertas-section.collapsed {
      display: none;
    }

    .alertas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #fef3c7;
      border-bottom: 2px solid #fbbf24;
      cursor: pointer;
      user-select: none;
    }

    .alertas-header h3 {
      margin: 0;
      font-size: 16px;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .alertas-toggle-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #92400e;
      transition: transform 0.3s;
    }

    .alertas-section.expanded .alertas-toggle-btn {
      transform: rotate(180deg);
    }

    .alertas-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 15px 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .alerta {
      padding: 10px;
      border-radius: 8px;
      border: 2px solid;
      font-size: 12px;
    }

    .alerta.critico {
      background: #000000;
      color: #DC2626;
      border-color: #DC2626;
    }

    .alerta.urgente {
      background: #DC2626;
      color: #FFFFFF;
      border-color: #DC2626;
    }

    .alerta.atencao {
      background: #EA580C;
      color: #FFFFFF;
      border-color: #EA580C;
    }

    .alerta.aviso {
      background: #FBBF24;
      color: #000000;
      border-color: #FBBF24;
    }

    .alerta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* Painel principal de notas */
    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
    }

    .btn-filter, .btn-sort {
      background: #f3f4f6;
      color: #374151;
      border: 2px solid #e5e7eb;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-filter:hover, .btn-sort:hover {
      background: #e5e7eb;
      border-color: #667eea;
    }

    .btn-filter.active, .btn-sort.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .filter-dropdown {
      position: relative;
      display: inline-block;
    }

    .filter-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 5px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      padding: 10px;
      min-width: 200px;
      z-index: 1000;
    }

    .filter-menu.show {
      display: block;
    }

    .filter-option {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
      transition: background 0.2s;
    }

    .filter-option:hover {
      background: #f3f4f6;
    }

    .filter-option.active {
      background: #eef2ff;
      color: #667eea;
      font-weight: 600;
    }

    .search-box {
      flex: 1;
      max-width: 600px;
      position: relative;
      min-width: 0;
    }

    .search-box input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
    }

    /* Tabela de notas - responsiva */
    .notas-table-container {
      background: transparent;
      border-radius: 0;
      padding: 0;
      overflow-x: auto;
      width: 100%;
      max-width: 100%;
    }

    .notas-table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .notas-table-container table {
      width: 100%;
      min-width: 900px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      color: #ffffff;
      font-size: 13px;
      border-bottom: none;
      white-space: nowrap;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
      color: #1f2937;
      vertical-align: middle;
    }

    /* Larguras espec√≠ficas das colunas - tabela de notas */
    #tabelaNotas th:nth-child(1), #tabelaNotas td:nth-child(1) { width: 28%; } /* T√≠tulo */
    #tabelaNotas th:nth-child(2), #tabelaNotas td:nth-child(2) { width: 12%; } /* Etiqueta */
    #tabelaNotas th:nth-child(3), #tabelaNotas td:nth-child(3) { width: 12%; } /* Status */
    #tabelaNotas th:nth-child(4), #tabelaNotas td:nth-child(4) { width: 11%; } /* Prazo */
    #tabelaNotas th:nth-child(5), #tabelaNotas td:nth-child(5) { width: 11%; } /* Data Cria√ß√£o */
    #tabelaNotas th:nth-child(6), #tabelaNotas td:nth-child(6) { width: 11%; } /* Data Atualiza√ß√£o */
    #tabelaNotas th:nth-child(7), #tabelaNotas td:nth-child(7) { width: 15%; text-align: center; } /* A√ß√µes */

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-etiqueta {
      background: #EDE9FE;
      color: #5B21B6;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .prazo-normal { color: #10B981; }
    .prazo-aviso { color: #FBBF24; font-weight: 600; }
    .prazo-atencao { color: #EA580C; font-weight: 700; }
    .prazo-urgente { color: #DC2626; font-weight: 700; }
    .prazo-atrasado {
      background: #000000;
      color: #DC2626;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
    }

    .btn-table {
      background: #f3f4f6;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 0 2px;
      transition: all 0.2s;
    }

    .btn-table:hover {
      background: #e5e7eb;
    }

    /* Modal - Menor */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: #374151;
    }

    .modal form {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
      font-size: 13px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Campo de cor melhorado */
    .color-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-input-wrapper input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 2px;
      cursor: pointer;
    }

    .color-preview {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }

    .btn-cancelar {
      background: #f3f4f6;
      color: #374151;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-cancelar:hover {
      background: #e5e7eb;
    }

    .btn-salvar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-salvar:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    /* Tabs para Status */
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #374151;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Status gerenciamento - Tabela */
    .status-table-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-x: auto;
      width: 100%;
    }

    .status-table {
      width: 100%;
      border-collapse: collapse;
    }

    .status-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      color: #ffffff;
      font-size: 13px;
      border-bottom: none;
    }

    .status-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
      color: #1f2937;
      vertical-align: middle;
    }

    .status-table tbody tr:hover {
      background: #f9fafb;
    }

    .status-table td:last-child {
      text-align: center;
    }

    .color-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.1);
      display: inline-block;
    }

    /* Prevenir overflow horizontal */
    .container {
      overflow-x: hidden;
    }

    /* Responsivo */
    @media (max-width: 1200px) {
      .etiquetas-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .etiquetas-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        gap: 0;
        overflow-x: auto;
      }

      .tab {
        padding: 10px 15px;
        font-size: 13px;
        white-space: nowrap;
      }

      .etiquetas-section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .etiquetas-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .etiquetas-controls input {
        width: 100% !important;
      }
    }

    /* Melhorias visuais adicionais */
    .notas-table-container {
      min-height: 400px;
    }

    table {
      font-size: 14px;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .nota-titulo {
      cursor: pointer;
      color: #667eea;
      font-weight: 500;
    }

    .nota-titulo:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="left-tools">
        <button id="btnSidebarToggle" class="btn-sidebar" aria-label="Alternar menu lateral">‚ò∞</button>
        <h1>üöÄ Sistema</h1>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-name" id="userName">Carregando...</div>
          <div class="user-email" id="userEmail"></div>
        </div>
        <button class="btn-logout" onclick="logout()">Sair</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <nav class="menu-lateral">
        <a href="/dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a>
        <a href="/notisblokk.html" class="active"><span class="icon">üìã</span><span class="label">Notisblokk</span></a>
        <a href="/usuarios.html"><span class="icon">üë•</span><span class="label">Usu√°rios</span></a>
      </nav>
    </aside>

    <main class="container" style="padding: 0; max-width: none;">
      <div class="notisblokk-layout">

        <!-- 1. Alertas no topo (colaps√°vel) -->
        <div class="alertas-section expanded" id="alertasSection">
          <div class="alertas-header" onclick="toggleAlertasSection()">
            <h3><span>üîî</span> Alertas <span id="alertasCount" style="font-size: 12px; opacity: 0.8;"></span></h3>
            <button class="alertas-toggle-btn">‚ñº</button>
          </div>
          <div class="alertas-container" id="alertasContainer">
            <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
              Carregando...
            </div>
          </div>
        </div>

        <!-- 2. Etiquetas (horizontal) -->
        <div class="etiquetas-section">
          <div class="etiquetas-section-header">
            <h3><span>üè∑Ô∏è</span> Etiquetas</h3>
            <div class="etiquetas-controls">
              <input type="text" id="buscaEtiquetas" placeholder="üîç Buscar..."
                     style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; width: 200px;">
              <button class="btn btn-small" onclick="modalNovaEtiqueta()">‚ûï Nova</button>
            </div>
          </div>
          <div class="etiquetas-grid" id="etiquetasGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6b7280;">
              Carregando...
            </div>
          </div>
        </div>

        <!-- 3. Tabs: Notas e Status -->
        <div class="card" style="padding: 0;">
          <div class="tabs" style="padding: 0 20px; padding-top: 20px; margin-bottom: 0;">
            <button class="tab active" onclick="switchTab('notas')">üìã Notas</button>
            <button class="tab" onclick="switchTab('status')">‚úÖ Status</button>
          </div>

          <!-- Tab: Notas -->
          <div id="tabNotas" class="tab-content active" style="padding: 20px;">
            <div class="toolbar">
              <div class="search-box">
                <input type="text" id="buscaNotas" placeholder="üîç Buscar notas..." oninput="filtrarNotas(this.value)">
              </div>

              <div class="toolbar-actions">
                <!-- Bot√£o de Ordenar -->
                <div class="filter-dropdown">
                  <button class="btn-sort" onclick="toggleSortMenu()">
                    <span>‚áÖ</span> Ordenar
                  </button>
                  <div class="filter-menu" id="sortMenu">
                    <div class="filter-option" onclick="ordenarPor('titulo', 'asc')">T√≠tulo (A-Z)</div>
                    <div class="filter-option" onclick="ordenarPor('titulo', 'desc')">T√≠tulo (Z-A)</div>
                    <div class="filter-option" onclick="ordenarPor('prazo', 'asc')">Prazo (Mais pr√≥ximo)</div>
                    <div class="filter-option" onclick="ordenarPor('prazo', 'desc')">Prazo (Mais distante)</div>
                    <div class="filter-option" onclick="ordenarPor('criacao', 'desc')">Mais recentes</div>
                    <div class="filter-option" onclick="ordenarPor('criacao', 'asc')">Mais antigas</div>
                  </div>
                </div>

                <!-- Bot√£o de Filtrar -->
                <div class="filter-dropdown">
                  <button class="btn-filter" onclick="toggleFilterMenu()">
                    <span>üîç</span> Filtrar
                  </button>
                  <div class="filter-menu" id="filterMenu">
                    <div class="filter-option active" onclick="filtrarPorStatus('todos')">üìã Todas</div>
                    <div style="border-top: 1px solid #e5e7eb; margin: 8px 0;"></div>
                    <div class="filter-option" onclick="filtrarPorPrazo('atrasadas')">üî¥ Atrasadas</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('urgentes')">üü† Urgentes (1-2 dias)</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('proximas')">üü° Pr√≥ximas (3-5 dias)</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('normais')">üü¢ Normais (6+ dias)</div>
                  </div>
                </div>

                <a href="/nota_cadastro.html" class="btn">‚ûï Nova Nota</a>
              </div>
            </div>

            <div class="notas-table-container" style="margin-top: 15px;">
              <div class="notas-table-wrapper">
                <table id="tabelaNotas">
                  <thead>
                    <tr>
                      <th>T√≠tulo</th>
                      <th>Etiqueta</th>
                      <th>Status</th>
                      <th>Prazo</th>
                      <th>Data Cria√ß√£o</th>
                      <th>Data Atualiza√ß√£o</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="corpoTabela">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">Carregando notas...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Tab: Status -->
          <div id="tabStatus" class="tab-content" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; font-size: 18px;">Gerenciar Status</h3>
              <button class="btn" onclick="modalNovoStatus()">‚ûï Novo Status</button>
            </div>
            <div class="status-table-container">
              <table class="status-table" id="statusTable">
                <thead>
                  <tr>
                    <th style="width: 50px;">Cor</th>
                    <th>Nome</th>
                    <th style="width: 150px;">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="statusTableBody">
                  <tr><td colspan="3" style="text-align: center; padding: 40px; color: #6b7280;">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Modal Nova/Editar Etiqueta -->
  <div id="modalEtiqueta" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalEtiquetaTitulo">Nova Etiqueta</h2>
        <button onclick="fecharModal('modalEtiqueta')" class="modal-close">√ó</button>
      </div>
      <form onsubmit="salvarEtiqueta(event)">
        <input type="hidden" id="etiquetaId">
        <div class="form-group">
          <label for="etiquetaNome">Nome da Etiqueta *</label>
          <input type="text" id="etiquetaNome" required maxlength="100" placeholder="Ex: Urgente">
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalEtiqueta')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Novo/Editar Status -->
  <div id="modalStatus" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalStatusTitulo">Novo Status</h2>
        <button onclick="fecharModal('modalStatus')" class="modal-close">√ó</button>
      </div>
      <form onsubmit="salvarStatus(event)">
        <input type="hidden" id="statusId">
        <div class="form-group">
          <label for="statusNome">Nome do Status *</label>
          <input type="text" id="statusNome" required maxlength="100" placeholder="Ex: Em andamento">
        </div>
        <div class="form-group">
          <label for="statusCor">Cor *</label>
          <div class="color-input-wrapper">
            <input type="color" id="statusCor" value="#667eea" onchange="atualizarPreviewCor()">
            <div class="color-preview" id="colorPreview" style="background: #667eea; color: #ffffff;">#667eea</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalStatus')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/notisblokk.js"></script>
  <script>
    // Autentica√ß√£o
    window.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('auth_token');
      if (!token) { window.location.href = '/login.html'; return; }

      const uLocal = localStorage.getItem('usuario');
      if (uLocal) {
        try {
          const u = JSON.parse(uLocal);
          if (u && u.nome) {
            document.getElementById('userName').textContent = u.nome;
            document.getElementById('userEmail').textContent = u.email || '';
          }
        } catch {}
      }

      try {
        const resp = await fetch('/api/auth/verificar', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        if (json.sucesso) {
          document.getElementById('userName').textContent = json.usuario.nome;
          document.getElementById('userEmail').textContent = json.usuario.email;
        }
      } catch {}
    });

    async function logout() {
      try {
        const token = localStorage.getItem('auth_token');
        await fetch('/api/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch {}
      localStorage.removeItem('auth_token');
      localStorage.removeItem('usuario');
      window.location.href = '/login.html';
    }

    // Toggle da sidebar colaps√°vel
    (function() {
      const layout = document.querySelector('.layout');
      const btn = document.getElementById('btnSidebarToggle');
      function applyState() {
        const collapsed = localStorage.getItem('sidebar_collapsed') === '1';
        if (collapsed) layout.classList.add('collapsed'); else layout.classList.remove('collapsed');
        if (btn) btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      }
      window.addEventListener('DOMContentLoaded', applyState);
      if (btn) {
        btn.addEventListener('click', () => {
          const collapsed = layout.classList.toggle('collapsed');
          localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0');
          btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        });
      }
    })();

    // Toggle alertas
    function toggleAlertasSection() {
      const section = document.getElementById('alertasSection');
      section.classList.toggle('expanded');
    }

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      if (tab === 'notas') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('tabNotas').classList.add('active');
      } else if (tab === 'status') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('tabStatus').classList.add('active');
        carregarStatusParaTabela();
      }
    }

    // Carregar etiquetas na se√ß√£o horizontal
    async function carregarEtiquetasParaGestao() {
      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch('/api/etiquetas', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        const grid = document.getElementById('etiquetasGrid');

        if (json.sucesso && json.dados.length > 0) {
          grid.innerHTML = json.dados.map(et => `
            <div class="etiqueta-card">
              <div class="etiqueta-info">
                <span>üè∑Ô∏è</span>
                <strong>${et.nome}</strong>
                <span class="etiqueta-contador">${et.contador || 0}</span>
              </div>
              <div class="etiqueta-acoes">
                <button class="btn-icone-small" onclick="editarEtiqueta(${et.id}, '${et.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" title="Editar">‚úèÔ∏è</button>
                <button class="btn-icone-small" onclick="excluirEtiqueta(${et.id}); event.stopPropagation();" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 20px;">Nenhuma etiqueta cadastrada.</div>';
        }
      } catch (e) {
        console.error('Erro ao carregar etiquetas:', e);
      }
    }

    // Filtrar etiquetas no grid
    function filtrarEtiquetasGrid(term) {
      const cards = document.querySelectorAll('.etiqueta-card');
      const busca = (term || '').toLowerCase();
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busca) ? 'flex' : 'none';
      });
    }

    // Event listener para busca de etiquetas
    document.addEventListener('DOMContentLoaded', () => {
      const buscaEtiquetas = document.getElementById('buscaEtiquetas');
      if (buscaEtiquetas) {
        buscaEtiquetas.addEventListener('input', (e) => filtrarEtiquetasGrid(e.target.value));
      }
      carregarEtiquetasParaGestao();

      // Fechar menus ao clicar fora
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
          document.querySelectorAll('.filter-menu').forEach(menu => menu.classList.remove('show'));
        }
      });
    });

    // Toggle menus de filtro e ordena√ß√£o
    function toggleSortMenu() {
      const menu = document.getElementById('sortMenu');
      const filterMenu = document.getElementById('filterMenu');
      menu.classList.toggle('show');
      filterMenu.classList.remove('show');
      event.stopPropagation();
    }

    function toggleFilterMenu() {
      const menu = document.getElementById('filterMenu');
      const sortMenu = document.getElementById('sortMenu');
      menu.classList.toggle('show');
      sortMenu.classList.remove('show');
      event.stopPropagation();
    }

    // Ordenar tabela
    function ordenarPor(campo, direcao) {
      const tbody = document.getElementById('corpoTabela');
      const linhas = Array.from(tbody.querySelectorAll('tr'));

      // Atualizar visual do menu
      document.querySelectorAll('#sortMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.sort((a, b) => {
        let valorA, valorB;

        if (campo === 'titulo') {
          valorA = a.cells[0]?.textContent.trim().toLowerCase() || ''; // Coluna 0: T√≠tulo
          valorB = b.cells[0]?.textContent.trim().toLowerCase() || '';
        } else if (campo === 'prazo') {
          valorA = converterDataBRParaComparacao(a.cells[3]?.textContent.trim() || ''); // Coluna 3: Prazo
          valorB = converterDataBRParaComparacao(b.cells[3]?.textContent.trim() || '');
        } else if (campo === 'criacao') {
          valorA = converterDataBRParaComparacao(a.cells[4]?.textContent.trim() || ''); // Coluna 4: Data Cria√ß√£o
          valorB = converterDataBRParaComparacao(b.cells[4]?.textContent.trim() || '');
        }

        if (direcao === 'asc') {
          return valorA > valorB ? 1 : -1;
        } else {
          return valorA < valorB ? 1 : -1;
        }
      });

      linhas.forEach(linha => tbody.appendChild(linha));
      document.getElementById('sortMenu').classList.remove('show');
    }

    function converterDataBRParaComparacao(dataStr) {
      const match = dataStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!match) return '';
      return `${match[3]}-${match[2]}-${match[1]}`;
    }

    // Filtrar por prazo
    function filtrarPorPrazo(tipo) {
      const linhas = document.querySelectorAll('#corpoTabela tr');

      // Atualizar visual do menu
      document.querySelectorAll('#filterMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.forEach(linha => {
        if (linha.cells.length <= 1) return; // Linha de carregamento/vazia

        const prazoCell = linha.cells[3]; // Coluna 3: Prazo
        const classePrazo = prazoCell?.className || '';

        let mostrar = false;

        if (tipo === 'todos') {
          mostrar = true;
        } else if (tipo === 'atrasadas') {
          mostrar = classePrazo.includes('prazo-atrasado');
        } else if (tipo === 'urgentes') {
          mostrar = classePrazo.includes('prazo-urgente');
        } else if (tipo === 'proximas') {
          mostrar = classePrazo.includes('prazo-atencao') || classePrazo.includes('prazo-aviso');
        } else if (tipo === 'normais') {
          mostrar = classePrazo.includes('prazo-normal');
        }

        linha.style.display = mostrar ? '' : 'none';
      });

      document.getElementById('filterMenu').classList.remove('show');
    }

    function filtrarPorStatus(tipo) {
      const linhas = document.querySelectorAll('#corpoTabela tr');

      // Atualizar visual do menu
      document.querySelectorAll('#filterMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.forEach(linha => {
        linha.style.display = '';
      });

      document.getElementById('filterMenu').classList.remove('show');
    }

    // Modais
    function modalNovaEtiqueta() {
      document.getElementById('etiquetaId').value = '';
      document.getElementById('etiquetaNome').value = '';
      document.getElementById('modalEtiquetaTitulo').textContent = 'Nova Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function editarEtiqueta(id, nome) {
      document.getElementById('etiquetaId').value = id;
      document.getElementById('etiquetaNome').value = nome;
      document.getElementById('modalEtiquetaTitulo').textContent = 'Editar Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function modalNovoStatus() {
      document.getElementById('statusId').value = '';
      document.getElementById('statusNome').value = '';
      document.getElementById('statusCor').value = '#667eea';
      document.getElementById('modalStatusTitulo').textContent = 'Novo Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    function atualizarPreviewCor() {
      const cor = document.getElementById('statusCor').value;
      const preview = document.getElementById('colorPreview');
      preview.style.background = cor;
      preview.textContent = cor.toUpperCase();

      // Ajustar cor do texto baseado na luminosidade
      const r = parseInt(cor.substr(1,2), 16);
      const g = parseInt(cor.substr(3,2), 16);
      const b = parseInt(cor.substr(5,2), 16);
      const luminance = (0.299*r + 0.587*g + 0.114*b);
      preview.style.color = luminance > 186 ? '#111827' : '#ffffff';
    }

    function fecharModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Carregar status como tabela
    async function carregarStatusParaTabela() {
      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        const tbody = document.getElementById('statusTableBody');

        if (json.sucesso && json.dados.length > 0) {
          tbody.innerHTML = json.dados.map(s => `
            <tr>
              <td><span class="color-dot" style="background: ${s.corHex}"></span></td>
              <td><strong>${s.nome}</strong></td>
              <td>
                <button class="btn-table" onclick="editarStatus(${s.id}, '${s.nome.replace(/'/g, "\\'")}', '${s.corHex}')" title="Editar">‚úèÔ∏è Editar</button>
                <button class="btn-table" onclick="excluirStatus(${s.id})" title="Excluir">üóëÔ∏è Excluir</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 40px;">Nenhum status cadastrado.</td></tr>';
        }
      } catch (e) {
        console.error('Erro ao carregar status:', e);
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ef4444; padding: 40px;">Erro ao carregar status.</td></tr>';
      }
    }

    // Fun√ß√£o antiga mantida para compatibilidade
    async function carregarStatusParaGestao() {
      await carregarStatusParaTabela();
    }

    function editarStatus(id, nome, cor) {
      document.getElementById('statusId').value = id;
      document.getElementById('statusNome').value = nome;
      document.getElementById('statusCor').value = cor;
      document.getElementById('modalStatusTitulo').textContent = 'Editar Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    async function salvarStatus(e) {
      e.preventDefault();
      const id = document.getElementById('statusId').value;
      const nome = document.getElementById('statusNome').value.trim();
      const cor = document.getElementById('statusCor').value;

      if (!nome) {
        alert('Informe o nome do status');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, corHex: cor })
        };

        const url = id ? `/api/status/${id}` : '/api/status';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalStatus');
          carregarStatusParaTabela();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao salvar status');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirStatus(id) {
      if (!confirm('Deseja realmente excluir este status?')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/status/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          carregarStatusParaTabela();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao excluir status');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }

    async function salvarEtiqueta(e) {
      e.preventDefault();
      const id = document.getElementById('etiquetaId').value;
      const nome = document.getElementById('etiquetaNome').value.trim();

      if (!nome) {
        alert('Informe o nome da etiqueta');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome })
        };

        const url = id ? `/api/etiquetas/${id}` : '/api/etiquetas';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalEtiqueta');
          carregarEtiquetasParaGestao();
          if (window.carregarEtiquetas) window.carregarEtiquetas();
        } else {
          alert(json.mensagem || 'Erro ao salvar etiqueta');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirEtiqueta(id) {
      if (!confirm('Deseja realmente excluir esta etiqueta?\nTodas as notas com esta etiqueta tamb√©m ser√£o exclu√≠das.')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/etiquetas/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          carregarEtiquetasParaGestao();
          if (window.carregarEtiquetas) window.carregarEtiquetas();
          if (window.carregarNotas) window.carregarNotas();
        } else {
          alert(json.mensagem || 'Erro ao excluir etiqueta');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }
  </script>
  <script src="/js/notisblokk.js"></script>
</body>
</html>
