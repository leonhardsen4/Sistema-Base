<!DOCTYPE html>
<!-- VERS√ÉO ATUALIZADA: Cards de Etiquetas - 2025-10-20 23:30 -->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notisblokk - Sistema</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/logo.png">
  <link rel="apple-touch-icon" href="/img/logo.png">
  <!-- Datepicker (Flatpickr) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="left-tools">
        <button id="btnSidebarToggle" class="btn-sidebar" aria-label="Alternar menu lateral">‚ò∞</button>
        <h1>Sistema</h1>
      </div>
      <div class="user-menu">
        <div class="theme-toggle" id="themeToggle">
          <div class="theme-toggle-option active" data-theme="light">‚òº</div>
          <div class="theme-toggle-option" data-theme="dark">‚òæ</div>
        </div>
        <div class="user-info">
          <div class="user-name" id="userName">Carregando...</div>
          <div class="user-email" id="userEmail"></div>
        </div>
        <button class="btn-logout" onclick="logout()">Sair</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <nav class="menu-lateral">
        <a href="/dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a>
        <a href="/notisblokk.html" class="active"><span class="icon">üìã</span><span class="label">Notisblokk</span></a>
        <a href="/usuarios.html"><span class="icon">üë•</span><span class="label">Usu√°rios</span></a>
      </nav>
    </aside>

    <main class="container" style="padding: 0; max-width: none;">
      <div class="notisblokk-layout">

        <!-- 1. Alertas no topo (colaps√°vel) -->
        <div class="alertas-section expanded" id="alertasSection">
          <div class="alertas-header" onclick="toggleAlertasSection()">
            <h3><span>üîî</span> Alertas <span id="alertasCount" style="font-size: 12px; opacity: 0.8;"></span></h3>
            <button class="alertas-toggle-btn">‚ñº</button>
          </div>
          <div class="alertas-container" id="alertasContainer">
            <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
              Carregando...
            </div>
          </div>
        </div>

        <!-- 2. Etiquetas (horizontal) -->
        <div class="etiquetas-section">
          <div class="etiquetas-section-header">
            <h3><span>üè∑Ô∏è</span> Etiquetas</h3>
            <div class="etiquetas-controls">
              <input type="text" id="buscaEtiquetas" placeholder="üîç Buscar..." class="search-input-small">
              <button class="btn btn-small" onclick="modalNovaEtiqueta()">+ Nova</button>
            </div>
          </div>
          <div class="etiquetas-grid" id="etiquetasGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6b7280;">
              Carregando...
            </div>
          </div>
        </div>

        <!-- 3. Tabs: Notas e Status -->
        <div class="card" style="padding: 0;">
          <div class="tabs" style="padding: 0 20px; padding-top: 20px; margin-bottom: 0;">
            <button class="tab active" onclick="switchTab('notas')">üìã Notas</button>
            <button class="tab" onclick="switchTab('status')">‚úÖ Status</button>
          </div>

          <!-- Tab: Notas -->
          <div id="tabNotas" class="tab-content active" style="padding: 20px;">
            <!-- Indicador de filtro por etiqueta -->
            <div id="indicadorFiltroEtiqueta" style="display: none; align-items: center; gap: 8px; padding: 10px 15px; background: var(--color-primary-light); border: 1px solid var(--color-primary); border-radius: 10px; margin-bottom: 15px;">
            </div>

            <div class="toolbar">
              <div class="search-box">
                <input type="text" id="buscaNotas" placeholder="üîç Buscar notas..." oninput="filtrarNotas(this.value)">
              </div>

              <div class="toolbar-actions">
                <!-- Bot√£o de Ordenar -->
                <div class="filter-dropdown">
                  <button class="btn-sort" onclick="toggleSortMenu()">
                    <span>‚áÖ</span> Ordenar
                  </button>
                  <div class="filter-menu" id="sortMenu">
                    <div class="filter-option" onclick="ordenarPor('titulo', 'asc')">T√≠tulo (A-Z)</div>
                    <div class="filter-option" onclick="ordenarPor('titulo', 'desc')">T√≠tulo (Z-A)</div>
                    <div class="filter-option" onclick="ordenarPor('prazo', 'asc')">Prazo (Mais pr√≥ximo)</div>
                    <div class="filter-option" onclick="ordenarPor('prazo', 'desc')">Prazo (Mais distante)</div>
                    <div class="filter-option" onclick="ordenarPor('criacao', 'desc')">Mais recentes</div>
                    <div class="filter-option" onclick="ordenarPor('criacao', 'asc')">Mais antigas</div>
                  </div>
                </div>

                <!-- Bot√£o de Filtrar -->
                <div class="filter-dropdown">
                  <button class="btn-filter" onclick="toggleFilterMenu()">
                    <span>üîç</span> Filtrar
                  </button>
                  <div class="filter-menu" id="filterMenu">
                    <div class="filter-option active" onclick="filtrarPorStatus('todos')">‚ñ° Todas</div>
                    <div style="border-top: 1px solid #e5e7eb; margin: 8px 0;"></div>
                    <div class="filter-option" onclick="filtrarPorPrazo('atrasadas')">üî¥ Atrasadas</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('urgentes')">üü† Urgentes (1-2 dias)</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('proximas')">üü° Pr√≥ximas (3-5 dias)</div>
                    <div class="filter-option" onclick="filtrarPorPrazo('normais')">üü¢ Normais (6+ dias)</div>
                  </div>
                </div>

                <a href="/nota_cadastro.html" class="btn">+ Nova Nota</a>
              </div>
            </div>

            <div class="notas-table-container" style="margin-top: 15px;">
              <div class="notas-table-wrapper">
                <table id="tabelaNotas">
                  <thead>
                    <tr>
                      <th>T√≠tulo</th>
                      <th>Etiqueta</th>
                      <th>Status</th>
                      <th>Prazo</th>
                      <th>Data Cria√ß√£o</th>
                      <th>Data Atualiza√ß√£o</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="corpoTabela">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">Carregando notas...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Tab: Status -->
          <div id="tabStatus" class="tab-content" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; font-size: 18px;">Gerenciar Status</h3>
              <button class="btn" onclick="modalNovoStatus()">+ Novo Status</button>
            </div>
            <div class="status-table-container">
              <table class="status-table" id="statusTable">
                <thead>
                  <tr>
                    <th style="width: 50px;">Cor</th>
                    <th>Nome</th>
                    <th style="width: 150px;">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="statusTableBody">
                  <tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--text-secondary);">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Modal Nova/Editar Etiqueta -->
  <div id="modalEtiqueta" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalEtiquetaTitulo">Nova Etiqueta</h2>
        <button onclick="fecharModal('modalEtiqueta')" class="modal-close">√ó</button>
      </div>
      <form onsubmit="salvarEtiqueta(event)">
        <input type="hidden" id="etiquetaId">
        <div class="form-group">
          <label for="etiquetaNome">Nome da Etiqueta *</label>
          <input type="text" id="etiquetaNome" required maxlength="100" placeholder="Ex: Urgente">
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalEtiqueta')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Novo/Editar Status -->
  <div id="modalStatus" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalStatusTitulo">Novo Status</h2>
        <button onclick="fecharModal('modalStatus')" class="modal-close">√ó</button>
      </div>
      <form onsubmit="salvarStatus(event)">
        <input type="hidden" id="statusId">
        <div class="form-group">
          <label for="statusNome">Nome do Status *</label>
          <input type="text" id="statusNome" required maxlength="100" placeholder="Ex: Em andamento">
        </div>
        <div class="form-group">
          <label for="statusCor">Cor *</label>
          <div class="color-input-wrapper">
            <input type="color" id="statusCor" value="#667eea" onchange="atualizarPreviewCor()">
            <div class="color-preview" id="colorPreview" style="background: var(--color-primary); color: #ffffff;">var(--color-primary)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalStatus')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/notisblokk.js"></script>
  <script>
    // Toggle de tema
    function initThemeToggle() {
      const toggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('theme') || 'light';

      // Aplicar tema salvo
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeToggleUI(savedTheme);

      // Event listener para toggle
      toggle.querySelectorAll('.theme-toggle-option').forEach(option => {
        option.addEventListener('click', () => {
          const theme = option.dataset.theme;
          document.documentElement.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
          updateThemeToggleUI(theme);
        });
      });
    }

    function updateThemeToggleUI(theme) {
      document.querySelectorAll('.theme-toggle-option').forEach(option => {
        if (option.dataset.theme === theme) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    // Autentica√ß√£o
    window.addEventListener('DOMContentLoaded', async () => {
      initThemeToggle();
      const token = localStorage.getItem('auth_token');
      if (!token) { window.location.href = '/login.html'; return; }

      const uLocal = localStorage.getItem('usuario');
      if (uLocal) {
        try {
          const u = JSON.parse(uLocal);
          if (u && u.nome) {
            document.getElementById('userName').textContent = u.nome;
            document.getElementById('userEmail').textContent = u.email || '';
          }
        } catch {}
      }

      try {
        const resp = await fetch('/api/auth/verificar', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        if (json.sucesso) {
          document.getElementById('userName').textContent = json.usuario.nome;
          document.getElementById('userEmail').textContent = json.usuario.email;
        }
      } catch {}
    });

    async function logout() {
      try {
        const token = localStorage.getItem('auth_token');
        await fetch('/api/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch {}
      localStorage.removeItem('auth_token');
      localStorage.removeItem('usuario');
      window.location.href = '/login.html';
    }

    // Toggle da sidebar colaps√°vel
    (function() {
      const layout = document.querySelector('.layout');
      const btn = document.getElementById('btnSidebarToggle');
      function applyState() {
        const collapsed = localStorage.getItem('sidebar_collapsed') === '1';
        if (collapsed) layout.classList.add('collapsed'); else layout.classList.remove('collapsed');
        if (btn) btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      }
      window.addEventListener('DOMContentLoaded', applyState);
      if (btn) {
        btn.addEventListener('click', () => {
          const collapsed = layout.classList.toggle('collapsed');
          localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0');
          btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        });
      }
    })();

    // Toggle alertas
    function toggleAlertasSection() {
      const section = document.getElementById('alertasSection');
      section.classList.toggle('expanded');
    }

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      if (tab === 'notas') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('tabNotas').classList.add('active');
      } else if (tab === 'status') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('tabStatus').classList.add('active');
        carregarStatusParaTabela();
      }
    }

    // Carregar etiquetas na se√ß√£o horizontal
    async function carregarEtiquetasParaGestao() {
      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch('/api/etiquetas', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        const grid = document.getElementById('etiquetasGrid');

        if (json.sucesso && json.dados.length > 0) {
          grid.innerHTML = json.dados.map(et => `
            <div class="etiqueta-card" data-id="${et.id}" onclick="selecionarEtiqueta(${et.id})">
              <div class="etiqueta-info">
                <span class="etiqueta-checkbox">‚òê</span>
                <strong>${et.nome}</strong>
                <span class="etiqueta-contador">${et.contador || 0}</span>
              </div>
              <div class="etiqueta-acoes">
                <button class="btn-icone-small" onclick="editarEtiqueta(${et.id}, '${et.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" title="Editar">‚úèÔ∏è</button>
                <button class="btn-icone-small" onclick="excluirEtiqueta(${et.id}); event.stopPropagation();" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;" class="vazio">Nenhuma etiqueta cadastrada.</div>';
        }
      } catch (e) {
        console.error('Erro ao carregar etiquetas:', e);
      }
    }

    // Filtrar etiquetas no grid
    function filtrarEtiquetasGrid(term) {
      const cards = document.querySelectorAll('.etiqueta-card');
      const busca = (term || '').toLowerCase();
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busca) ? 'flex' : 'none';
      });
    }

    // Event listener para busca de etiquetas
    document.addEventListener('DOMContentLoaded', () => {
      const buscaEtiquetas = document.getElementById('buscaEtiquetas');
      if (buscaEtiquetas) {
        buscaEtiquetas.addEventListener('input', (e) => filtrarEtiquetasGrid(e.target.value));
      }
      carregarEtiquetasParaGestao();

      // Fechar menus ao clicar fora
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
          document.querySelectorAll('.filter-menu').forEach(menu => menu.classList.remove('show'));
        }
      });
    });

    // Toggle menus de filtro e ordena√ß√£o
    function toggleSortMenu() {
      const menu = document.getElementById('sortMenu');
      const filterMenu = document.getElementById('filterMenu');
      menu.classList.toggle('show');
      filterMenu.classList.remove('show');
      event.stopPropagation();
    }

    function toggleFilterMenu() {
      const menu = document.getElementById('filterMenu');
      const sortMenu = document.getElementById('sortMenu');
      menu.classList.toggle('show');
      sortMenu.classList.remove('show');
      event.stopPropagation();
    }

    // Ordenar tabela
    function ordenarPor(campo, direcao) {
      const tbody = document.getElementById('corpoTabela');
      const linhas = Array.from(tbody.querySelectorAll('tr'));

      // Atualizar visual do menu
      document.querySelectorAll('#sortMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.sort((a, b) => {
        let valorA, valorB;

        if (campo === 'titulo') {
          valorA = a.cells[0]?.textContent.trim().toLowerCase() || ''; // Coluna 0: T√≠tulo
          valorB = b.cells[0]?.textContent.trim().toLowerCase() || '';
        } else if (campo === 'prazo') {
          valorA = converterDataBRParaComparacao(a.cells[3]?.textContent.trim() || ''); // Coluna 3: Prazo
          valorB = converterDataBRParaComparacao(b.cells[3]?.textContent.trim() || '');
        } else if (campo === 'criacao') {
          valorA = converterDataBRParaComparacao(a.cells[4]?.textContent.trim() || ''); // Coluna 4: Data Cria√ß√£o
          valorB = converterDataBRParaComparacao(b.cells[4]?.textContent.trim() || '');
        }

        if (direcao === 'asc') {
          return valorA > valorB ? 1 : -1;
        } else {
          return valorA < valorB ? 1 : -1;
        }
      });

      linhas.forEach(linha => tbody.appendChild(linha));
      document.getElementById('sortMenu').classList.remove('show');
    }

    function converterDataBRParaComparacao(dataStr) {
      const match = dataStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!match) return '';
      return `${match[3]}-${match[2]}-${match[1]}`;
    }

    // Filtrar por prazo
    function filtrarPorPrazo(tipo) {
      const linhas = document.querySelectorAll('#corpoTabela tr');

      // Atualizar visual do menu
      document.querySelectorAll('#filterMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.forEach(linha => {
        if (linha.cells.length <= 1) return; // Linha de carregamento/vazia

        const prazoCell = linha.cells[3]; // Coluna 3: Prazo
        const classePrazo = prazoCell?.className || '';

        let mostrar = false;

        if (tipo === 'todos') {
          mostrar = true;
        } else if (tipo === 'atrasadas') {
          mostrar = classePrazo.includes('prazo-atrasado');
        } else if (tipo === 'urgentes') {
          mostrar = classePrazo.includes('prazo-urgente');
        } else if (tipo === 'proximas') {
          mostrar = classePrazo.includes('prazo-atencao') || classePrazo.includes('prazo-aviso');
        } else if (tipo === 'normais') {
          mostrar = classePrazo.includes('prazo-normal');
        }

        linha.style.display = mostrar ? '' : 'none';
      });

      document.getElementById('filterMenu').classList.remove('show');
    }

    function filtrarPorStatus(tipo) {
      const linhas = document.querySelectorAll('#corpoTabela tr');

      // Atualizar visual do menu
      document.querySelectorAll('#filterMenu .filter-option').forEach(opt => opt.classList.remove('active'));
      event.target.classList.add('active');

      linhas.forEach(linha => {
        linha.style.display = '';
      });

      document.getElementById('filterMenu').classList.remove('show');
    }

    // Modais
    function modalNovaEtiqueta() {
      document.getElementById('etiquetaId').value = '';
      document.getElementById('etiquetaNome').value = '';
      document.getElementById('modalEtiquetaTitulo').textContent = 'Nova Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function editarEtiqueta(id, nome) {
      document.getElementById('etiquetaId').value = id;
      document.getElementById('etiquetaNome').value = nome;
      document.getElementById('modalEtiquetaTitulo').textContent = 'Editar Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function modalNovoStatus() {
      document.getElementById('statusId').value = '';
      document.getElementById('statusNome').value = '';
      document.getElementById('statusCor').value = '#667eea';
      document.getElementById('modalStatusTitulo').textContent = 'Novo Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    function atualizarPreviewCor() {
      const cor = document.getElementById('statusCor').value;
      const preview = document.getElementById('colorPreview');
      preview.style.background = cor;
      preview.textContent = cor.toUpperCase();

      // Ajustar cor do texto baseado na luminosidade
      const r = parseInt(cor.substr(1,2), 16);
      const g = parseInt(cor.substr(3,2), 16);
      const b = parseInt(cor.substr(5,2), 16);
      const luminance = (0.299*r + 0.587*g + 0.114*b);
      preview.style.color = luminance > 186 ? '#111827' : '#ffffff';
    }

    function fecharModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Carregar status como tabela
    async function carregarStatusParaTabela() {
      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        const tbody = document.getElementById('statusTableBody');

        if (json.sucesso && json.dados.length > 0) {
          tbody.innerHTML = json.dados.map(s => `
            <tr>
              <td><span class="color-dot" style="background: ${s.corHex}"></span></td>
              <td><strong>${s.nome}</strong></td>
              <td>
                <button class="btn-table" onclick="editarStatus(${s.id}, '${s.nome.replace(/'/g, "\\'")}', '${s.corHex}')" title="Editar">‚úé</button>
                <button class="btn-table" onclick="excluirStatus(${s.id})" title="Excluir">‚úï</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="3" class="vazio">Nenhum status cadastrado.</td></tr>';
        }
      } catch (e) {
        console.error('Erro ao carregar status:', e);
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--color-danger); padding: 40px;">Erro ao carregar status.</td></tr>';
      }
    }

    // Fun√ß√£o antiga mantida para compatibilidade
    async function carregarStatusParaGestao() {
      await carregarStatusParaTabela();
    }

    function editarStatus(id, nome, cor) {
      document.getElementById('statusId').value = id;
      document.getElementById('statusNome').value = nome;
      document.getElementById('statusCor').value = cor;
      document.getElementById('modalStatusTitulo').textContent = 'Editar Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    async function salvarStatus(e) {
      e.preventDefault();
      const id = document.getElementById('statusId').value;
      const nome = document.getElementById('statusNome').value.trim();
      const cor = document.getElementById('statusCor').value;

      if (!nome) {
        alert('Informe o nome do status');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, corHex: cor })
        };

        const url = id ? `/api/status/${id}` : '/api/status';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalStatus');
          carregarStatusParaTabela();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao salvar status');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirStatus(id) {
      if (!confirm('Deseja realmente excluir este status?')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/status/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          carregarStatusParaTabela();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao excluir status');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }

    async function salvarEtiqueta(e) {
      e.preventDefault();
      const id = document.getElementById('etiquetaId').value;
      const nome = document.getElementById('etiquetaNome').value.trim();

      if (!nome) {
        alert('Informe o nome da etiqueta');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome })
        };

        const url = id ? `/api/etiquetas/${id}` : '/api/etiquetas';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalEtiqueta');
          carregarEtiquetasParaGestao();
          if (window.carregarEtiquetas) window.carregarEtiquetas();
        } else {
          alert(json.mensagem || 'Erro ao salvar etiqueta');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirEtiqueta(id) {
      if (!confirm('Deseja realmente excluir esta etiqueta?\nTodas as notas com esta etiqueta tamb√©m ser√£o exclu√≠das.')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/etiquetas/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          carregarEtiquetasParaGestao();
          if (window.carregarEtiquetas) window.carregarEtiquetas();
          if (window.carregarNotas) window.carregarNotas();
        } else {
          alert(json.mensagem || 'Erro ao excluir etiqueta');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }
  </script>
</body>
</html>
