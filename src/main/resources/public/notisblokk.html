<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📋 Notisblokk - Sistema</title>
  <link rel="stylesheet" href="/css/layout.css">
  <!-- Datepicker (Flatpickr) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }

    /* Layout principal - 2 colunas */
    .notisblokk-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Sidebar esquerda completa */
    .sidebar-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-header h3 {
      font-size: 16px;
      color: #1f2937;
      margin: 0;
    }

    /* Etiquetas */
    .etiquetas-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 350px;
      overflow-y: auto;
    }

    .etiqueta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .etiqueta-item:hover {
      background: #f9fafb;
      border-color: #667eea;
    }

    .etiqueta-item.selected {
      background: #eef2ff;
      border-color: #667eea;
    }

    .etiqueta-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .etiqueta-nome {
      flex: 1;
      font-weight: 500;
      font-size: 13px;
    }

    .etiqueta-contador {
      font-size: 11px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .btn-icone-small {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 2px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .btn-icone-small:hover {
      opacity: 1;
    }

    /* Alertas */
    .alertas-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .alerta {
      padding: 10px;
      border-radius: 8px;
      border: 2px solid;
      font-size: 12px;
    }

    .alerta.critico {
      background: #000000;
      color: #DC2626;
      border-color: #DC2626;
    }

    .alerta.urgente {
      background: #DC2626;
      color: #FFFFFF;
      border-color: #DC2626;
    }

    .alerta.atencao {
      background: #EA580C;
      color: #FFFFFF;
      border-color: #EA580C;
    }

    .alerta.aviso {
      background: #FBBF24;
      color: #000000;
      border-color: #FBBF24;
    }

    .alerta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* Painel principal de notas */
    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .toolbar {
      display: flex;
      gap: 15px;
      align-items: center;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-box {
      flex: 1;
      max-width: 600px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
    }

    /* Tabela de notas - mais largura */
    .notas-table-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
      border-bottom: 2px solid #e5e7eb;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
      color: #1f2937;
    }

    tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-etiqueta {
      background: #EDE9FE;
      color: #5B21B6;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .prazo-normal { color: #10B981; }
    .prazo-aviso { color: #FBBF24; font-weight: 600; }
    .prazo-atencao { color: #EA580C; font-weight: 700; }
    .prazo-urgente { color: #DC2626; font-weight: 700; }
    .prazo-atrasado {
      background: #000000;
      color: #DC2626;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
    }

    .btn-table {
      background: #f3f4f6;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 0 2px;
      transition: all 0.2s;
    }

    .btn-table:hover {
      background: #e5e7eb;
    }

    /* Modal - Menor */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: #374151;
    }

    .modal form {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
      font-size: 13px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Campo de cor melhorado */
    .color-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-input-wrapper input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 2px;
      cursor: pointer;
    }

    .color-preview {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }

    .btn-cancelar {
      background: #f3f4f6;
      color: #374151;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-cancelar:hover {
      background: #e5e7eb;
    }

    .btn-salvar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-salvar:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    /* Tabs para Status */
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #374151;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Status gerenciamento */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    .status-card {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .status-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }

    .status-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .color-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.1);
    }

    /* Responsivo */
    @media (max-width: 1200px) {
      .notisblokk-layout {
        grid-template-columns: 1fr;
      }

      .sidebar-left {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
    }

    @media (max-width: 768px) {
      .sidebar-left {
        grid-template-columns: 1fr;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .status-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="left-tools">
        <button id="btnSidebarToggle" class="btn-sidebar" aria-label="Alternar menu lateral">☰</button>
        <h1>🚀 Sistema</h1>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-name" id="userName">Carregando...</div>
          <div class="user-email" id="userEmail"></div>
        </div>
        <button class="btn-logout" onclick="logout()">Sair</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <nav class="menu-lateral">
        <a href="/dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a>
        <a href="/notisblokk.html" class="active"><span class="icon">📋</span><span class="label">Notisblokk</span></a>
        <a href="/usuarios.html"><span class="icon">👥</span><span class="label">Usuários</span></a>
      </nav>
    </aside>

    <main class="container" style="padding: 0; max-width: none;">
      <div class="notisblokk-layout">
        <!-- Sidebar esquerda: Etiquetas e Alertas -->
        <div class="sidebar-left">
          <!-- Etiquetas -->
          <div class="card">
            <div class="card-header">
              <h3>🏷️ Etiquetas</h3>
              <button class="btn-small" onclick="modalNovaEtiqueta()" title="Nova Etiqueta">➕</button>
            </div>
            <input type="text" id="buscaEtiquetas" placeholder="🔍 Buscar..."
                   style="width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box;"
                   oninput="filtrarEtiquetas(this.value)">
            <div class="etiquetas-list" id="listaEtiquetas">
              <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
                Carregando...
              </div>
            </div>
          </div>

          <!-- Alertas -->
          <div class="card">
            <div class="card-header">
              <h3>🔔 Alertas</h3>
            </div>
            <div class="alertas-container" id="alertasContainer">
              <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
                Carregando...
              </div>
            </div>
          </div>
        </div>

        <!-- Painel principal: Tabs (Notas / Status) -->
        <div class="main-panel">
          <div class="card" style="padding: 0;">
            <div class="tabs" style="padding: 0 20px; padding-top: 20px; margin-bottom: 0;">
              <button class="tab active" onclick="switchTab('notas')">📋 Notas</button>
              <button class="tab" onclick="switchTab('status')">✅ Status</button>
            </div>

            <!-- Tab: Notas -->
            <div id="tabNotas" class="tab-content active" style="padding: 20px;">
              <div class="toolbar">
                <div class="search-box">
                  <input type="text" id="buscaNotas" placeholder="🔍 Buscar notas..." oninput="filtrarNotas(this.value)">
                </div>
                <a href="/nota_cadastro.html" class="btn">➕ Nova Nota</a>
              </div>

              <div class="notas-table-container">
                <table id="tabelaNotas">
                  <thead>
                    <tr>
                      <th>Título</th>
                      <th>Etiqueta</th>
                      <th>Status</th>
                      <th>Prazo</th>
                      <th>Data Criação</th>
                      <th style="width: 140px;">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="corpoTabela">
                    <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Carregando notas...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tab: Status -->
            <div id="tabStatus" class="tab-content" style="padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px;">Gerenciar Status</h3>
                <button class="btn" onclick="modalNovoStatus()">➕ Novo Status</button>
              </div>
              <div class="status-grid" id="statusGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                  Carregando...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Nova/Editar Etiqueta -->
  <div id="modalEtiqueta" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalEtiquetaTitulo">Nova Etiqueta</h2>
        <button onclick="fecharModal('modalEtiqueta')" class="modal-close">×</button>
      </div>
      <form onsubmit="salvarEtiqueta(event)">
        <input type="hidden" id="etiquetaId">
        <div class="form-group">
          <label for="etiquetaNome">Nome da Etiqueta *</label>
          <input type="text" id="etiquetaNome" required maxlength="100" placeholder="Ex: Urgente">
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalEtiqueta')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Novo/Editar Status -->
  <div id="modalStatus" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalStatusTitulo">Novo Status</h2>
        <button onclick="fecharModal('modalStatus')" class="modal-close">×</button>
      </div>
      <form onsubmit="salvarStatus(event)">
        <input type="hidden" id="statusId">
        <div class="form-group">
          <label for="statusNome">Nome do Status *</label>
          <input type="text" id="statusNome" required maxlength="100" placeholder="Ex: Em andamento">
        </div>
        <div class="form-group">
          <label for="statusCor">Cor *</label>
          <div class="color-input-wrapper">
            <input type="color" id="statusCor" value="#667eea" onchange="atualizarPreviewCor()">
            <div class="color-preview" id="colorPreview" style="background: #667eea; color: #ffffff;">#667eea</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="fecharModal('modalStatus')" class="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/notisblokk.js"></script>
  <script>
    // Autenticação
    window.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('auth_token');
      if (!token) { window.location.href = '/login.html'; return; }

      const uLocal = localStorage.getItem('usuario');
      if (uLocal) {
        try {
          const u = JSON.parse(uLocal);
          if (u && u.nome) {
            document.getElementById('userName').textContent = u.nome;
            document.getElementById('userEmail').textContent = u.email || '';
          }
        } catch {}
      }

      try {
        const resp = await fetch('/api/auth/verificar', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        if (json.sucesso) {
          document.getElementById('userName').textContent = json.usuario.nome;
          document.getElementById('userEmail').textContent = json.usuario.email;
        }
      } catch {}
    });

    async function logout() {
      try {
        const token = localStorage.getItem('auth_token');
        await fetch('/api/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch {}
      localStorage.removeItem('auth_token');
      localStorage.removeItem('usuario');
      window.location.href = '/login.html';
    }

    // Toggle da sidebar colapsável
    (function() {
      const layout = document.querySelector('.layout');
      const btn = document.getElementById('btnSidebarToggle');
      function applyState() {
        const collapsed = localStorage.getItem('sidebar_collapsed') === '1';
        if (collapsed) layout.classList.add('collapsed'); else layout.classList.remove('collapsed');
        if (btn) btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      }
      window.addEventListener('DOMContentLoaded', applyState);
      if (btn) {
        btn.addEventListener('click', () => {
          const collapsed = layout.classList.toggle('collapsed');
          localStorage.setItem('sidebar_collapsed', collapsed ? '1' : '0');
          btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        });
      }
    })();

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

      if (tab === 'notas') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('tabNotas').classList.add('active');
      } else if (tab === 'status') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('tabStatus').classList.add('active');
        carregarStatusParaGestao();
      }
    }

    // Modais
    function modalNovaEtiqueta() {
      document.getElementById('etiquetaId').value = '';
      document.getElementById('etiquetaNome').value = '';
      document.getElementById('modalEtiquetaTitulo').textContent = 'Nova Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function editarEtiqueta(id, nome) {
      document.getElementById('etiquetaId').value = id;
      document.getElementById('etiquetaNome').value = nome;
      document.getElementById('modalEtiquetaTitulo').textContent = 'Editar Etiqueta';
      document.getElementById('modalEtiqueta').classList.add('show');
    }

    function modalNovoStatus() {
      document.getElementById('statusId').value = '';
      document.getElementById('statusNome').value = '';
      document.getElementById('statusCor').value = '#667eea';
      document.getElementById('modalStatusTitulo').textContent = 'Novo Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    function atualizarPreviewCor() {
      const cor = document.getElementById('statusCor').value;
      const preview = document.getElementById('colorPreview');
      preview.style.background = cor;
      preview.textContent = cor.toUpperCase();

      // Ajustar cor do texto baseado na luminosidade
      const r = parseInt(cor.substr(1,2), 16);
      const g = parseInt(cor.substr(3,2), 16);
      const b = parseInt(cor.substr(5,2), 16);
      const luminance = (0.299*r + 0.587*g + 0.114*b);
      preview.style.color = luminance > 186 ? '#111827' : '#ffffff';
    }

    function fecharModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Carregar status para gestão
    async function carregarStatusParaGestao() {
      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await resp.json();
        const grid = document.getElementById('statusGrid');

        if (json.sucesso && json.dados.length > 0) {
          grid.innerHTML = json.dados.map(s => `
            <div class="status-card">
              <div class="status-info">
                <span class="color-dot" style="background: ${s.corHex}"></span>
                <strong>${s.nome}</strong>
              </div>
              <div style="display: flex; gap: 4px;">
                <button class="btn-icone-small" onclick="editarStatus(${s.id}, '${s.nome.replace(/'/g, "\\'")}', '${s.corHex}')" title="Editar">✏️</button>
                <button class="btn-icone-small" onclick="excluirStatus(${s.id})" title="Excluir">🗑️</button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 40px;">Nenhum status cadastrado.</div>';
        }
      } catch (e) {
        console.error('Erro ao carregar status:', e);
      }
    }

    function editarStatus(id, nome, cor) {
      document.getElementById('statusId').value = id;
      document.getElementById('statusNome').value = nome;
      document.getElementById('statusCor').value = cor;
      document.getElementById('modalStatusTitulo').textContent = 'Editar Status';
      atualizarPreviewCor();
      document.getElementById('modalStatus').classList.add('show');
    }

    async function salvarStatus(e) {
      e.preventDefault();
      const id = document.getElementById('statusId').value;
      const nome = document.getElementById('statusNome').value.trim();
      const cor = document.getElementById('statusCor').value;

      if (!nome) {
        alert('Informe o nome do status');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome, corHex: cor })
        };

        const url = id ? `/api/status/${id}` : '/api/status';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalStatus');
          carregarStatusParaGestao();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao salvar status');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirStatus(id) {
      if (!confirm('Deseja realmente excluir este status?')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/status/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          carregarStatusParaGestao();
          if (window.carregarStatus) window.carregarStatus();
        } else {
          alert(json.mensagem || 'Erro ao excluir status');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }

    async function salvarEtiqueta(e) {
      e.preventDefault();
      const id = document.getElementById('etiquetaId').value;
      const nome = document.getElementById('etiquetaNome').value.trim();

      if (!nome) {
        alert('Informe o nome da etiqueta');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const opts = {
          method: id ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nome })
        };

        const url = id ? `/api/etiquetas/${id}` : '/api/etiquetas';
        const resp = await fetch(url, opts);
        const json = await resp.json();

        if (json.sucesso) {
          fecharModal('modalEtiqueta');
          if (window.carregarEtiquetas) window.carregarEtiquetas();
        } else {
          alert(json.mensagem || 'Erro ao salvar etiqueta');
        }
      } catch (e) {
        alert('Erro ao salvar: ' + e.message);
      }
    }

    async function excluirEtiqueta(id) {
      if (!confirm('Deseja realmente excluir esta etiqueta?\nTodas as notas com esta etiqueta também serão excluídas.')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const resp = await fetch(`/api/etiquetas/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();

        if (json.sucesso) {
          if (window.carregarEtiquetas) window.carregarEtiquetas();
          if (window.carregarNotas) window.carregarNotas();
        } else {
          alert(json.mensagem || 'Erro ao excluir etiqueta');
        }
      } catch (e) {
        alert('Erro ao excluir: ' + e.message);
      }
    }
  </script>
</body>
</html>
